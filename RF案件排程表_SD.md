# ğŸ“™ RFæ¡ˆä»¶æ’ç¨‹ç³»çµ± â€” ç³»çµ±è¨­è¨ˆæ–‡ä»¶ (SD v2.0)

---

## 1. ç³»çµ±æ¶æ§‹è¨­è¨ˆ

### 1.1 æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WinForms Application (DevExpress)                â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚Wizard  â”‚  â”‚WorkLog â”‚  â”‚Loading â”‚  â”‚Report  â”‚   â”‚  â”‚
â”‚  â”‚  â”‚Forms   â”‚  â”‚Forms   â”‚  â”‚Forms   â”‚  â”‚Forms   â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“ HTTPS (JSON)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        ASP.NET Core Web API (.NET 8)              â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Controllers                                  â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â”‚Authâ”‚ â”‚Projâ”‚ â”‚Testâ”‚ â”‚Workâ”‚ â”‚Loadâ”‚ â”‚Auditâ”‚   â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜    â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Filters & Middleware                         â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Authentication Filter                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Authorization Filter                       â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ AuditLog Filter                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Exception Handler Middleware               â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Services (Business Logic)                    â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ ProjectService                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ WorkLogService                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ LoadingService                             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ AuditLogService                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ EmailService                               â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Access Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚        Entity Framework Core 8.0                  â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ DbContext: RFSchedulingDbContext             â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Query Filters (Soft Delete)                â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Change Tracking                            â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Transaction Management                     â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚ Repositories (Optional)                      â”‚ â”‚  â”‚
â”‚  â”‚  â”‚ â€¢ Generic Repository Pattern                 â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Database Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          SQL Server 2019 Express                  â”‚  â”‚
â”‚  â”‚  â€¢ Tables (20+ tables)                            â”‚  â”‚
â”‚  â”‚  â€¢ Indexes                                        â”‚  â”‚
â”‚  â”‚  â€¢ Foreign Keys                                   â”‚  â”‚
â”‚  â”‚  â€¢ Stored Procedures (Optional)                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    External Services                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  SMTP Server (Email Notifications)                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 1.2 åˆ†å±¤è·è²¬èªªæ˜

#### 1.2.1 Presentation Layer (WinForms)
**è·è²¬ï¼š**
- ä½¿ç”¨è€…äº’å‹•ä»‹é¢
- è¼¸å…¥é©—è­‰ï¼ˆå‰ç«¯é©—è­‰ï¼‰
- é¡¯ç¤ºè³‡æ–™èˆ‡éŒ¯èª¤è¨Šæ¯
- å‘¼å«Web API

**æŠ€è¡“ï¼š**
- WinForms (.NET 8)
- DevExpress WinForms Controls
- HttpClient (APIé€šè¨Š)
- Newtonsoft.Json (JSONåºåˆ—åŒ–)

**ä¸åŒ…å«ï¼š**
- æ¥­å‹™é‚è¼¯é‹ç®—
- ç›´æ¥å­˜å–è³‡æ–™åº«
- è¤‡é›œçš„è³‡æ–™è™•ç†

---

#### 1.2.2 Application Layer (Web API)
**è·è²¬ï¼š**
- æ¥æ”¶HTTPè«‹æ±‚
- èº«ä»½é©—è­‰èˆ‡æˆæ¬Š
- æ¥­å‹™é‚è¼¯è™•ç†
- Transactionç®¡ç†
- å›æ‡‰HTTPå›æ‡‰

**æŠ€è¡“ï¼š**
- ASP.NET Core Web API 8.0
- JWT Bearer Authentication
- AutoMapper (DTOæ˜ å°„)
- FluentValidation (é©—è­‰)

**é—œéµServiceï¼š**
- **ProjectService:** æ¡ˆä»¶å»ºç«‹ã€ä¿®æ”¹ã€ç‹€æ…‹è¨ˆç®—
- **WorkLogService:** å·¥æ™‚å›å ±ã€ç‹€æ…‹åŒæ­¥
- **LoadingService:** Loadingè¨ˆç®—
- **AuditLogService:** ç¨½æ ¸æ—¥èªŒè¨˜éŒ„
- **EmailService:** Emailç™¼é€ï¼ˆå¯†ç¢¼é‡è¨­ã€é€šçŸ¥ï¼‰

---

#### 1.2.3 Data Access Layer (EF Core)
**è·è²¬ï¼š**
- ORMå°æ‡‰
- Queryå„ªåŒ–
- Change Tracking
- Transactionç®¡ç†
- Soft Deleteè™•ç†

**æŠ€è¡“ï¼š**
- Entity Framework Core 8.0
- Code First Approach
- Migrationç®¡ç†

**é—œéµæ©Ÿåˆ¶ï¼š**
- Soft Delete
- AuditLogè‡ªå‹•è¨˜éŒ„
- RowVersion
---

#### 1.2.4 Database Layer (SQL Server)
**è·è²¬ï¼š**
- è³‡æ–™æŒä¹…åŒ–
- è³‡æ–™å®Œæ•´æ€§ç´„æŸ
- ç´¢å¼•å„ªåŒ–
- å‚™ä»½èˆ‡å¾©åŸ

**æŠ€è¡“ï¼š**
- SQL Server 2019 Express
- Database Edition: Express

---

## 2. è³‡æ–™åº«è¨­è¨ˆ

### 2.1 è³‡æ–™åº«æ¶æ§‹ç¸½è¦½

**è³‡æ–™åº«åç¨±ï¼š** RFScheduling

**å­—ç¬¦é›†ï¼š** UTF-8 

**Collationï¼š** Chinese_Taiwan_Stroke_CI_AS

**è³‡æ–™è¡¨æ•¸é‡ï¼š** 14å€‹ä¸»è¦è³‡æ–™è¡¨

---

### 2.2 å®Œæ•´è³‡æ–™è¡¨è¨­è¨ˆ

#### 2.2.1 Role (è§’è‰²)
```sql
CREATE TABLE [dbo].[Role] (
    [RoleId]        INT            IDENTITY(1,1) NOT NULL,
    [RoleName]      NVARCHAR(50)   NOT NULL,
    [Description]   NVARCHAR(50)   NOT NULL,
    CONSTRAINT [PK_Role] PRIMARY KEY CLUSTERED ([RoleId])
);

-- åˆå§‹è³‡æ–™
INSERT INTO [Role] (RoleName, Description) VALUES 
    ('Engineer', 'å·¥ç¨‹å¸«'),
    ('Manager', 'ä¸»ç®¡');
```

---

#### 2.2.2 User (ä½¿ç”¨è€…)
```sql
CREATE TABLE [dbo].[User] (
    [UserId]                INT          IDENTITY(1,1) NOT NULL,
    [Account]               NVARCHAR(50)   NOT NULL,
    [PasswordHash]          NVARCHAR(255)  NOT NULL,
    [DisplayName]           NVARCHAR(100)  NOT NULL,
    [Email]                 NVARCHAR(255)  NOT NULL,
    [RoleId]                INT            NOT NULL,
    [WeeklyAvailableHours]  DECIMAL(5,2)   NOT NULL DEFAULT 37.5,
    [IsActive]              BIT            NOT NULL DEFAULT 1,
    [CreatedByUserId]       INT            NULL,
    [CreatedDate]           DATETIME       NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]          DATETIME       NULL,
    [IsDeleted]             BIT            NOT NULL DEFAULT 0,
    [DeletedByUserId]       INT            NULL,
    [DeletedDate]           DATETIME       NULL,
    [RowVersion]            ROWVERSION     NOT NULL,
    CONSTRAINT [PK_User] PRIMARY KEY CLUSTERED ([UserId]),
    CONSTRAINT [FK_User_Role] FOREIGN KEY ([RoleId]) 
        REFERENCES [Role]([RoleId]),
    CONSTRAINT [UQ_User_Account] UNIQUE ([Account]),
    CONSTRAINT [UQ_User_Email] UNIQUE ([Email]),
    CONSTRAINT [CK_User_WeeklyHours] CHECK ([WeeklyAvailableHours] > 0 AND [WeeklyAvailableHours] <= 72)
);

CREATE NONCLUSTERED INDEX [IX_User_RoleId] ON [User]([RoleId]);
CREATE NONCLUSTERED INDEX [IX_User_IsActive] ON [User]([IsActive]) WHERE [IsDeleted] = 0;
```

**æ¬„ä½èªªæ˜ï¼š**
- `PasswordHash`: ä½¿ç”¨bcrypt Hashï¼Œé•·åº¦255è¶³å¤ 
- `WeeklyAvailableHours`: æ¯é€±å¯å·¥ä½œæ™‚æ•¸ï¼Œé è¨­37.5ï¼ˆæ¯æ—¥7.5å°æ™‚Ã—5å¤©ï¼‰
- `RowVersion`: ç”¨æ–¼ä½µç™¼æ§åˆ¶

---

#### 2.2.3 PasswordReset (å¯†ç¢¼é‡è¨­)
```sql
CREATE TABLE [dbo].[PasswordReset] (
    [PasswordResetId]   INT             IDENTITY(1,1) NOT NULL,
    [UserId]            INT             NOT NULL,
    [Token]             NVARCHAR(255)   NOT NULL,
    [ExpireAt]          DATETIME        NOT NULL,
    [UsedAt]            DATETIME        NULL,
    [CreatedDate]       DATETIME        NOT NULL DEFAULT GETDATE(),
    CONSTRAINT [PK_PasswordReset] PRIMARY KEY CLUSTERED ([PasswordResetId]),
    CONSTRAINT [FK_PasswordReset_User] FOREIGN KEY ([UserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [UQ_PasswordReset_Token] UNIQUE ([Token])
);

CREATE NONCLUSTERED INDEX [IX_PasswordReset_UserId] ON [PasswordReset]([UserId]);
```

**æ¬„ä½èªªæ˜ï¼š**
- `Token`: GUID + Hashï¼Œç”¨æ–¼Emailé€£çµ
- `ExpireAt`: åˆ°æœŸæ™‚é–“ï¼ˆå»ºç«‹å¾Œ30åˆ†é˜ï¼‰
- `UsedAt`: ä½¿ç”¨æ™‚é–“ï¼ŒNULLè¡¨ç¤ºæœªä½¿ç”¨

---

#### 2.2.4 Project (æ¡ˆä»¶)
```sql
CREATE TABLE [dbo].[Project] (
    [ProjectId]         INT             IDENTITY(1,1) NOT NULL,
    [ProjectName]       NVARCHAR(200)   NOT NULL,
    [Customer]          NVARCHAR(200)   NULL,
    [Priority]          NVARCHAR(20)    NOT NULL DEFAULT 'Medium', -- High, Medium, Low
    [Status]            NVARCHAR(20)    NOT NULL DEFAULT 'Draft', -- Draft, Active, Completed, OnHold, Delayed
    [StartDate]         DATE            NULL,
    [EndDate]           DATE            NULL,
    [Note]              NVARCHAR(1000)  NULL,
    [CreatedByUserId]   INT             NOT NULL,
    [CreatedDate]       DATETIME     NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]      DATETIME        NULL,
    [IsDeleted]         BIT             NOT NULL DEFAULT 0,
    [DeletedByUserId]   INT             NULL,
    [DeletedDate]       DATETIME        NULL,
    [RowVersion]        ROWVERSION      NOT NULL,
    CONSTRAINT [PK_Project] PRIMARY KEY CLUSTERED ([ProjectId]),
    CONSTRAINT [FK_Project_CreatedBy] FOREIGN KEY ([CreatedByUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [UQ_Project_Name] UNIQUE ([ProjectName]) WHERE [IsDeleted] = 0,
    CONSTRAINT [CK_Project_Priority] CHECK ([Priority] IN ('High', 'Medium', 'Low')),
    CONSTRAINT [CK_Project_Status] CHECK ([Status] IN ('Draft', 'Active', 'Completed', 'OnHold', 'Delayed')),
    CONSTRAINT [CK_Project_DateRange] CHECK ([EndDate] IS NULL OR [StartDate] IS NULL OR [EndDate] >= [StartDate])
);

CREATE NONCLUSTERED INDEX [IX_Project_Status] ON [Project]([Status]) WHERE [IsDeleted] = 0;
CREATE NONCLUSTERED INDEX [IX_Project_CreatedDate] ON [Project]([CreatedDate]) WHERE [IsDeleted] = 0;
```

---

#### 2.2.5 Regulation (æ³•è¦)
```sql
CREATE TABLE [dbo].[Regulation] (
    [RegulationId]      INT             IDENTITY(1,1) NOT NULL,
    [ProjectId]         INT             NOT NULL,
    [RegulationName]    NVARCHAR(100)   NOT NULL, -- FCC, NCC, CE, IC, TELEC
    [StartDate]         DATE            NOT NULL,
    [EndDate]           DATE            NOT NULL,
    [Note]              NVARCHAR(500)   NULL,
    [CreatedByUserId]   INT             NOT NULL,
    [CreatedDate]       DATETIME        NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]      DATETIME        NULL,
    [IsDeleted]         BIT             NOT NULL DEFAULT 0,
    [DeletedByUserId]   INT             NULL,
    [DeletedDate]       DATETIME        NULL,
    CONSTRAINT [PK_Regulation] PRIMARY KEY CLUSTERED ([RegulationId]),
    CONSTRAINT [FK_Regulation_Project] FOREIGN KEY ([ProjectId]) 
        REFERENCES [Project]([ProjectId]),
    CONSTRAINT [FK_Regulation_CreatedBy] FOREIGN KEY ([CreatedByUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [CK_Regulation_DateRange] CHECK ([EndDate] >= [StartDate])
);

CREATE NONCLUSTERED INDEX [IX_Regulation_ProjectId] ON [Regulation]([ProjectId]) WHERE [IsDeleted] = 0;
```

---

#### 2.2.6 TestItem (æ¸¬è©¦é …ç›®)
```sql
CREATE TABLE [dbo].[TestItem] (
    [TestItemId]        INT             IDENTITY(1,1) NOT NULL,
    [RegulationId]      INT             NOT NULL,
    [TestItemName]      NVARCHAR(200)   NOT NULL,
    [TestType]          NVARCHAR(100)   NOT NULL, -- Conducted, Radiated, Blocking, DFS, PWS, Adaptivity
    [TestLocation]      NVARCHAR(100)   NOT NULL, -- Lab A, Lab B, Lab C
    [EstimatedHours]    DECIMAL(10,2)   NOT NULL,
    [Status]            NVARCHAR(20)    NOT NULL DEFAULT 'NotStarted',
    [ManagerNote]       NVARCHAR(500)   NULL,
    [CreatedByUserId]   INT             NOT NULL,
    [CreatedDate]       DATETIME     NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]      DATETIME        NULL,
    [IsDeleted]         BIT             NOT NULL DEFAULT 0,
    [DeletedByUserId]   INT             NULL,
    [DeletedDate]       DATETIME        NULL,
    [RowVersion]        ROWVERSION      NOT NULL,
    CONSTRAINT [PK_TestItem] PRIMARY KEY CLUSTERED ([TestItemId]),
    CONSTRAINT [FK_TestItem_Regulation] FOREIGN KEY ([RegulationId]) 
        REFERENCES [Regulation]([RegulationId]),
    CONSTRAINT [FK_TestItem_CreatedBy] FOREIGN KEY ([CreatedByUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [CK_TestItem_Status] CHECK ([Status] IN ('NotStarted', 'InProgress', 'Completed', 'Delayed', 'OnHold')),
    CONSTRAINT [CK_TestItem_EstimatedHours] CHECK ([EstimatedHours] > 0)
);

CREATE NONCLUSTERED INDEX [IX_TestItem_RegulationId] ON [TestItem]([RegulationId]) WHERE [IsDeleted] = 0;
CREATE NONCLUSTERED INDEX [IX_TestItem_Status] ON [TestItem]([Status]) WHERE [IsDeleted] = 0;
```

---

#### 2.2.7 TestItemEngineer (å·¥ç¨‹å¸«åˆ†é…)
```sql
CREATE TABLE [dbo].[TestItemEngineer] (
    [TestItemEngineerId]    INT          IDENTITY(1,1) NOT NULL,
    [TestItemId]            INT             NOT NULL,
    [EngineerUserId]        INT             NOT NULL,
    [RoleType]              NVARCHAR(20)    NOT NULL, -- Main, Sub
    [AssignedHours]         DECIMAL(10,2)   NOT NULL,
    [CreatedByUserId]       INT             NOT NULL,
    [CreatedDate]           DATETIME        NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]          DATETIME        NULL,
    [IsDeleted]             BIT             NOT NULL DEFAULT 0,
    [DeletedByUserId]       INT             NULL,
    [DeletedDate]           DATETIME        NULL,
    CONSTRAINT [PK_TestItemEngineer] PRIMARY KEY CLUSTERED ([TestItemEngineerId]),
    CONSTRAINT [FK_TestItemEngineer_TestItem] FOREIGN KEY ([TestItemId]) 
        REFERENCES [TestItem]([TestItemId]),
    CONSTRAINT [FK_TestItemEngineer_User] FOREIGN KEY ([EngineerUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [FK_TestItemEngineer_CreatedBy] FOREIGN KEY ([CreatedByUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [CK_TestItemEngineer_RoleType] CHECK ([RoleType] IN ('Main', 'Sub')),
    CONSTRAINT [CK_TestItemEngineer_AssignedHours] CHECK ([AssignedHours] > 0)
);

CREATE UNIQUE NONCLUSTERED INDEX [UQ_TestItemEngineer] 
    ON [TestItemEngineer]([TestItemId], [EngineerUserId]) 
    WHERE [IsDeleted] = 0;

CREATE NONCLUSTERED INDEX [IX_TestItemEngineer_EngineerUserId] 
    ON [TestItemEngineer]([EngineerUserId]) WHERE [IsDeleted] = 0;
```

**æ¬„ä½èªªæ˜ï¼š**
- `RoleType`: Main=ä¸»è¦è² è²¬ï¼ŒSub=æ”¯æ´
- `AssignedHours`: åˆ†é…çµ¦è©²å·¥ç¨‹å¸«çš„å·¥æ™‚

---

#### 2.2.8 TestItemRevision (è£œæ¸¬ç‰ˆæœ¬)
```sql
CREATE TABLE [dbo].[TestItemRevision] (
    [RevisionId]        INT             IDENTITY(1,1) NOT NULL,
    [TestItemId]        INT             NOT NULL,
    [RevisionNumber]    NVARCHAR(10)    NOT NULL, -- v2, v3, v4
    [EstimatedHours]    DECIMAL(10,2)   NOT NULL,
    [Reason]            NVARCHAR(200)   NOT NULL,
    [Description]       NVARCHAR(500)   NULL,
    [CreatedByUserId]   INT             NOT NULL,
    [CreatedDate]       DATETIME        NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]      DATETIME        NULL,
    [IsDeleted]         BIT             NOT NULL DEFAULT 0,
    [DeletedByUserId]   INT             NULL,
    [DeletedDate]       DATETIME        NULL,
    CONSTRAINT [PK_TestItemRevision] PRIMARY KEY CLUSTERED ([RevisionId]),
    CONSTRAINT [FK_TestItemRevision_TestItem] FOREIGN KEY ([TestItemId]) 
        REFERENCES [TestItem]([TestItemId]),
    CONSTRAINT [FK_TestItemRevision_CreatedBy] FOREIGN KEY ([CreatedByUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [CK_TestItemRevision_EstimatedHours] CHECK ([EstimatedHours] > 0)
);

CREATE UNIQUE NONCLUSTERED INDEX [UQ_TestItemRevision] 
    ON [TestItemRevision]([TestItemId], [RevisionNumber]) 
    WHERE [IsDeleted] = 0;
```

---

#### 2.2.9 WorkLog (å·¥æ™‚è¨˜éŒ„)
```sql
CREATE TABLE [dbo].[WorkLog] (
    [WorkLogId]             INT          IDENTITY(1,1) NOT NULL,
    [TestItemId]            INT             NOT NULL,
    [RevisionId]            INT             NULL, -- NULL = v1
    [EngineerUserId]        INT             NOT NULL,
    [WorkDate]              DATE            NOT NULL,
    [ActualHours]           DECIMAL(10,2)   NOT NULL,
    [Status]                NVARCHAR(20)    NOT NULL, -- InProgress, Completed, Delayed
    [Comment]               NVARCHAR(500)   NULL,
    [CreatedDate]           DATETIME        NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]          DATETIME        NULL,
    [ModificationReason]    NVARCHAR(500)   NULL, -- Managerè¦†å¯«æ™‚å¡«å¯«
    CONSTRAINT [PK_WorkLog] PRIMARY KEY CLUSTERED ([WorkLogId]),
    CONSTRAINT [FK_WorkLog_TestItem] FOREIGN KEY ([TestItemId]) 
        REFERENCES [TestItem]([TestItemId]),
    CONSTRAINT [FK_WorkLog_Revision] FOREIGN KEY ([RevisionId]) 
        REFERENCES [TestItemRevision]([RevisionId]),
    CONSTRAINT [CK_WorkLog_Status] CHECK ([Status] IN ('InProgress', 'Completed', 'Delayed')),
    CONSTRAINT [CK_WorkLog_ActualHours] CHECK ([ActualHours] > 0 AND [ActualHours] <= 12)
);

CREATE UNIQUE NONCLUSTERED INDEX [UQ_WorkLog_DateUser] 
    ON [WorkLog]([TestItemId], [EngineerUserId], [WorkDate], [RevisionId]);

CREATE NONCLUSTERED INDEX [IX_WorkLog_EngineerUserId] 
    ON [WorkLog]([EngineerUserId]);

CREATE NONCLUSTERED INDEX [IX_WorkLog_WorkDate] 
    ON [WorkLog]([WorkDate]);
```

**æ¬„ä½èªªæ˜ï¼š**
- `RevisionId`: NULLè¡¨ç¤ºv1ï¼ˆåŸå§‹ç‰ˆæœ¬ï¼‰ï¼ŒéNULLè¡¨ç¤ºè£œæ¸¬ç‰ˆæœ¬
- `ModificationReason`: Managerä¿®æ”¹å·¥æ™‚æ™‚å¡«å¯«ç†ç”±

---

#### 2.2.10 DelayReason (å»¶é²åŸå› )
```sql
CREATE TABLE [dbo].[DelayReason] (
    [DelayReasonId]     INT             IDENTITY(1,1) NOT NULL,
    [ReasonText]        NVARCHAR(200)   NOT NULL,
    [ReasonType]        NVARCHAR(50)    NOT NULL, -- Equipment, Customer, Engineer, Location, Other
    [IsActive]          BIT             NOT NULL DEFAULT 1,
    [CreatedByUserId]   INT             NOT NULL,
    [CreatedDate]       DATETIME     NOT NULL DEFAULT GETDATE(),
    [ModifiedDate]      DATETIME        NULL,
    CONSTRAINT [PK_DelayReason] PRIMARY KEY CLUSTERED ([DelayReasonId]),
    CONSTRAINT [FK_DelayReason_CreatedBy] FOREIGN KEY ([CreatedByUserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [CK_DelayReason_Type] CHECK ([ReasonType] IN ('Equipment', 'Customer', 'Engineer', 'Location', 'Other')),
    CONSTRAINT [UQ_DelayReason_Text] UNIQUE ([ReasonText])
);

CREATE NONCLUSTERED INDEX [IX_DelayReason_IsActive] ON [DelayReason]([IsActive]);

-- åˆå§‹è³‡æ–™
INSERT INTO [DelayReason] (ReasonText, ReasonType, CreatedByUserId) VALUES 
    ('æ¸¬è©¦è¨­å‚™æ•…éšœ', 'Equipment', 1),
    ('å®¢æˆ¶å»¶é²æä¾›æ¨£å“', 'Customer', 1),
    ('å·¥ç¨‹å¸«äººåŠ›ä¸è¶³', 'Engineer', 1),
    ('æ¸¬è©¦å ´åœ°è¢«ä½”ç”¨', 'Location', 1),
    ('å…¶ä»–åŸå› ', 'Other', 1);
```

---

#### 2.2.11 WorkLogDelayReason (å·¥æ™‚å»¶é²åŸå› é—œè¯)
```sql
CREATE TABLE [dbo].[WorkLogDelayReason] (
    [WorkLogDelayReasonId]  INT         IDENTITY(1,1) NOT NULL,
    [WorkLogId]             INT         NOT NULL,
    [DelayReasonId]         INT         NOT NULL,
    CONSTRAINT [PK_WorkLogDelayReason] PRIMARY KEY CLUSTERED ([WorkLogDelayReasonId]),
    CONSTRAINT [FK_WorkLogDelayReason_WorkLog] FOREIGN KEY ([WorkLogId]) 
        REFERENCES [WorkLog]([WorkLogId]) ON DELETE CASCADE,
    CONSTRAINT [FK_WorkLogDelayReason_DelayReason] FOREIGN KEY ([DelayReasonId]) 
        REFERENCES [DelayReason]([DelayReasonId])
);

CREATE UNIQUE NONCLUSTERED INDEX [UQ_WorkLogDelayReason] 
    ON [WorkLogDelayReason]([WorkLogId], [DelayReasonId]);

CREATE NONCLUSTERED INDEX [IX_WorkLogDelayReason_DelayReasonId] 
    ON [WorkLogDelayReason]([DelayReasonId]);
```

---

#### 2.2.12 AuditLog (ç¨½æ ¸æ—¥èªŒ)
```sql
CREATE TABLE [dbo].[AuditLog] (
    [AuditLogId]    BIGINT          IDENTITY(1,1) NOT NULL,
    [TableName]     NVARCHAR(50)    NOT NULL,
    [RecordId]      INT             NOT NULL,
    [Action]        NVARCHAR(20)    NOT NULL, -- Create, Update, Delete, PasswordReset
    [OldValue]      NVARCHAR(MAX)   NULL, -- JSON
    [NewValue]      NVARCHAR(MAX)   NULL, -- JSON
    [UserId]        INT             NOT NULL,
    [ModifiedDate]  DATETIME        NOT NULL DEFAULT GETDATE(),
    [Reason]        NVARCHAR(500)   NULL,
    CONSTRAINT [PK_AuditLog] PRIMARY KEY CLUSTERED ([AuditLogId]),
    CONSTRAINT [FK_AuditLog_User] FOREIGN KEY ([UserId]) 
        REFERENCES [User]([UserId]),
    CONSTRAINT [CK_AuditLog_Action] CHECK ([Action] IN ('Create', 'Update', 'Delete', 'PasswordReset'))
);

CREATE NONCLUSTERED INDEX [IX_AuditLog_TableRecord] 
    ON [AuditLog]([TableName], [RecordId]);

CREATE NONCLUSTERED INDEX [IX_AuditLog_UserId] 
    ON [AuditLog]([UserId]);

CREATE NONCLUSTERED INDEX [IX_AuditLog_ModifiedDate] 
    ON [AuditLog]([ModifiedDate] DESC);
```

**æ¬„ä½èªªæ˜ï¼š**
- `OldValue` / `NewValue`: å„²å­˜JSONæ ¼å¼çš„è®Šæ›´å‰å¾Œå€¼
- `Reason`: é‡è¦ä¿®æ”¹éœ€å¡«å¯«ç†ç”±ï¼ˆå¦‚Managerè¦†å¯«å·¥æ™‚ï¼‰

---

#### 2.2.13 SystemSetting (ç³»çµ±è¨­å®š)
```sql
CREATE TABLE [dbo].[SystemSetting] (
    [SettingId]     INT             IDENTITY(1,1) NOT NULL,
    [SettingKey]    NVARCHAR(100)   NOT NULL,
    [SettingValue]  NVARCHAR(500)   NULL,
    [Description]   NVARCHAR(200)   NULL,
    [ModifiedDate]  DATETIME        NULL,
    CONSTRAINT [PK_SystemSetting] PRIMARY KEY CLUSTERED ([SettingId]),
    CONSTRAINT [UQ_SystemSetting_Key] UNIQUE ([SettingKey])
);

-- åˆå§‹è³‡æ–™
INSERT INTO [SystemSetting] (SettingKey, SettingValue, Description) VALUES 
    ('DefaultWeeklyHours', '37.5', 'é è¨­æ¯é€±å·¥ä½œæ™‚æ•¸'),
    ('WorkLogEditDays', '7', 'WorkLogå¯ä¿®æ”¹å¤©æ•¸'),
    ('LoginFailLimit', '5', 'ç™»å…¥å¤±æ•—é–å®šæ¬¡æ•¸'),
    ('LockoutMinutes', '10', 'é–å®šæ™‚é–“(åˆ†é˜)'),
    ('PasswordResetExpireMinutes', '30', 'å¯†ç¢¼é‡è¨­é€£çµæœ‰æ•ˆæœŸé™(åˆ†é˜)'),
    ('AuditLogRetentionDays', '365', 'AuditLogä¿ç•™å¤©æ•¸'),
    ('DeletedDataRetentionDays', '180', 'å·²åˆªé™¤è³‡æ–™ä¿ç•™å¤©æ•¸'),
    ('SmtpServer', 'smtp.company.com', 'SMTPä¼ºæœå™¨'),
    ('SmtpPort', '25', 'SMTP Port'),
    ('SmtpEnableSSL', 'false', 'æ˜¯å¦å•Ÿç”¨SSL'),
    ('SenderEmail', 'noreply@company.com', 'å¯„ä»¶è€…Email'),
    ('SenderName', 'RFæ’ç¨‹ç³»çµ±', 'å¯„ä»¶è€…åç¨±');
```

---

### 2.3 è³‡æ–™åº«é—œè¯åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Role   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ 1:N
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   User   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ PasswordReset    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1:N     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ 1:N
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Project  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ 1:N
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Regulationâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ 1:N
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TestItem â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚TestItemRevision  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ 1:N     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘                      â†‘
      â”‚ N:M                  â”‚
      â”‚                      â”‚ 0:N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚TestItemEngineer  â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
      â†‘                      â”‚
      â”‚ 1:N                  â”‚
      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚ WorkLog  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†‘
      â”‚ N:M
      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚WorkLogDelayReasonâ”‚â”€â”€â”€â†’â”‚DelayReasonâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ N:1â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚AuditLog  â”‚ (ç¨ç«‹è¨˜éŒ„æ‰€æœ‰ç•°å‹•)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2.4 ç´¢å¼•ç­–ç•¥

#### 2.4.1 é—œéµæŸ¥è©¢çš„ç´¢å¼•

**æŸ¥è©¢1ï¼šå·¥ç¨‹å¸«æŸ¥çœ‹è‡ªå·±çš„æ¸¬é …**
```sql
-- Query: SELECT * FROM TestItem WHERE EngineerUserId = @UserId AND IsDeleted = 0
-- Index: IX_TestItemEngineer_EngineerUserId 
```

**æŸ¥è©¢2ï¼šLoadingè¨ˆç®—**
```sql
-- Query: 
-- SELECT EngineerUserId, SUM(AssignedHours) 
-- FROM TestItemEngineer tie
-- JOIN TestItem ti ON tie.TestItemId = ti.TestItemId
-- JOIN Regulation r ON ti.RegulationId = r.RegulationId
-- JOIN Project p ON r.ProjectId = p.ProjectId
-- WHERE p.Status = 'Active' AND tie.IsDeleted = 0
-- GROUP BY EngineerUserId

-- éœ€è¦çš„ç´¢å¼•ï¼š
CREATE NONCLUSTERED INDEX [IX_Project_Status_Include] 
    ON [Project]([Status]) 
    INCLUDE ([ProjectId])
    WHERE [IsDeleted] = 0;
```

**æŸ¥è©¢3ï¼šæ¡ˆä»¶é€²åº¦å ±è¡¨**
```sql
-- Query: 
-- SELECT * FROM Project p
-- LEFT JOIN Regulation r ON p.ProjectId = r.ProjectId
-- LEFT JOIN TestItem ti ON r.RegulationId = ti.RegulationId
-- WHERE p.ProjectId = @ProjectId

-- Index: å·²æœ‰FKç´¢å¼•ï¼Œç„¡éœ€é¡å¤–å»ºç«‹
```

**æŸ¥è©¢4ï¼šç¨½æ ¸æ—¥èªŒæŸ¥è©¢**
```sql
-- Query: 
-- SELECT * FROM AuditLog 
-- WHERE TableName = @TableName AND RecordId = @RecordId
-- ORDER BY ModifiedDate DESC

-- Index: IX_AuditLog_TableRecord (å·²å»ºç«‹)
```

---

#### 2.4.2 è¦†è“‹ç´¢å¼• (Covering Index)

**å·¥æ™‚æŸ¥è©¢å„ªåŒ–ï¼š**
```sql
CREATE NONCLUSTERED INDEX [IX_WorkLog_Covering] 
    ON [WorkLog]([EngineerUserId], [WorkDate])
    INCLUDE ([TestItemId], [ActualHours], [Status])
    WHERE [WorkDate] >= DATEADD(MONTH, -3, GETDATE());
```

**èªªæ˜ï¼š** é‡å°è¿‘3å€‹æœˆçš„å·¥æ™‚æŸ¥è©¢å„ªåŒ–ï¼ŒåŒ…å«å¸¸ç”¨æ¬„ä½é¿å…Key Lookup

---

## 3. APIè¨­è¨ˆè¦ç¯„

### 3.1 APIç«¯é»ç¸½è¦½

**Base URLï¼š** `https://api.company.com/api`

**ç‰ˆæœ¬æ§åˆ¶ï¼š** URL Path (`/v1/`)

**å®Œæ•´URLç¯„ä¾‹ï¼š** `https://api.company.com/api/v1/auth/login`

---

### 3.2 èªè­‰æ¨¡çµ„ API

#### 3.2.1 POST /api/v1/auth/login
**åŠŸèƒ½ï¼š** ä½¿ç”¨è€…ç™»å…¥

#### 3.2.2 POST /api/v1/auth/forgot-password
**åŠŸèƒ½ï¼š** ç”³è«‹å¯†ç¢¼é‡è¨­

#### 3.2.3 GET /api/v1/auth/validate-reset-token
**åŠŸèƒ½ï¼š** é©—è­‰é‡è¨­Token

#### 3.2.4 POST /api/v1/auth/reset-password
**åŠŸèƒ½ï¼š** åŸ·è¡Œå¯†ç¢¼é‡è¨­

---

### 3.3 æ¡ˆä»¶ç®¡ç† API

#### 3.3.1 POST /api/v1/projects/create-with-wizard
**åŠŸèƒ½ï¼š** Wizardå»ºæ¡ˆï¼ˆä¸€æ¬¡æ€§å»ºç«‹å®Œæ•´æ¡ˆä»¶ï¼‰

#### 3.3.2 GET /api/v1/projects
**åŠŸèƒ½ï¼š** å–å¾—æ¡ˆä»¶æ¸…å–®

#### 3.3.3 GET /api/v1/projects/{id}
**åŠŸèƒ½ï¼š** å–å¾—æ¡ˆä»¶è©³ç´°è³‡è¨Š

---

### 3.4 å·¥æ™‚ç®¡ç† API

#### 3.4.1 GET /api/v1/worklogs/my-tasks
**åŠŸèƒ½ï¼š** å–å¾—æˆ‘çš„æ¸¬é …æ¸…å–®ï¼ˆå·¥ç¨‹å¸«å°ˆç”¨ï¼‰

#### 3.4.2 POST /api/v1/worklogs
**åŠŸèƒ½ï¼š** å›å ±å·¥æ™‚

#### 3.4.3 GET /api/v1/worklogs/testitem/{testItemId}
**åŠŸèƒ½ï¼š** å–å¾—æ¸¬é …çš„å·¥æ™‚è¨˜éŒ„

---

### 3.5 Loadingåˆ†æ API

#### 3.5.1 GET /api/v1/loading/engineers
**åŠŸèƒ½ï¼š** å–å¾—æ‰€æœ‰å·¥ç¨‹å¸«Loading

#### 3.5.2 GET /api/v1/loading/engineers/{id}
**åŠŸèƒ½ï¼š** å–å¾—å·¥ç¨‹å¸«Loadingæ˜ç´°

---

## 4. å®‰å…¨è¨­è¨ˆ

### 4.1 èªè­‰æ©Ÿåˆ¶ (Authentication)

#### 4.1.1 JWT Tokenè¨­è¨ˆ

**Token Payloadï¼š**

**Token Generation (C#)ï¼š**

---

#### 4.1.2 å¯†ç¢¼Hashè¨­è¨ˆ

**ä½¿ç”¨bcryptï¼š**

---

#### 4.1.3 å¯†ç¢¼é‡è¨­Tokenè¨­è¨ˆ

**Tokenç”Ÿæˆï¼š**

---

### 4.2 æˆæ¬Šæ©Ÿåˆ¶ (Authorization)

#### 4.2.1 Role-Based Access Control

**Controllerå±¤ç´šæˆæ¬Šï¼š**

**Actionå±¤ç´šæˆæ¬Šï¼š**

---

#### 4.2.2 Resource-Based Authorization

**å·¥ç¨‹å¸«åªèƒ½æŸ¥çœ‹/ä¿®æ”¹è‡ªå·±çš„WorkLogï¼š**

---

### 4.3 APIå®‰å…¨æœ€ä½³å¯¦è¸

#### 4.3.1 HTTPSå¼·åˆ¶

#### 4.3.2 CORSè¨­å®š

#### 4.3.3 Rate Limiting

### 4.4 SQL Injectioné˜²è­·

**ä½¿ç”¨Parameterized Query (EF Coreè‡ªå‹•è™•ç†)ï¼š**
```csharp
// âœ… å®‰å…¨ï¼šEF Coreè‡ªå‹•åƒæ•¸åŒ–
var projects = await _dbContext.Projects
    .Where(p => p.ProjectName.Contains(keyword))
    .ToListAsync();

// âœ… å¦‚æœå¿…é ˆä½¿ç”¨åŸç”ŸSQLï¼Œä½¿ç”¨åƒæ•¸åŒ–
var projects = await _dbContext.Projects
    .FromSqlRaw("SELECT * FROM Project WHERE ProjectName LIKE {0}", $"%{keyword}%")
    .ToListAsync();
```
### 4.5 XSSé˜²è­·

**å‰ç«¯è™•ç†ï¼š**
```csharp
// WinFormsæœƒè‡ªå‹•è™•ç†TextBoxçš„HTMLç·¨ç¢¼
// ä½†åœ¨é¡¯ç¤ºå¯Œæ–‡æœ¬æ™‚éœ€æ³¨æ„

public string SanitizeHtml(string input)
{
    // ä½¿ç”¨HtmlAgilityPackæˆ–é¡ä¼¼Library
    return System.Net.WebUtility.HtmlEncode(input);
}
```

**APIå›æ‡‰ï¼š**
- JSONåºåˆ—åŒ–è‡ªå‹•è™•ç†ç‰¹æ®Šå­—å…ƒ
- ä¸å›å‚³åŸå§‹HTML

---

## 5. Entity Framework Coreè¨­è¨ˆ

### 5.1 DbContextè¨­è¨ˆ

```csharp
public class RFSchedulingDbContext : DbContext
{
    public RFSchedulingDbContext(DbContextOptions options)
        : base(options)
    {
    }

    // DbSets
    public DbSet Users { get; set; }
    public DbSet Roles { get; set; }
    public DbSet PasswordResets { get; set; }
    public DbSet Projects { get; set; }
    public DbSet Regulations { get; set; }
    public DbSet TestItems { get; set; }
    public DbSet TestItemEngineers { get; set; }
    public DbSet TestItemRevisions { get; set; }
    public DbSet WorkLogs { get; set; }
    public DbSet DelayReasons { get; set; }
    public DbSet WorkLogDelayReasons { get; set; }
    public DbSet AuditLogs { get; set; }
    public DbSet SystemSettings { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // å¥—ç”¨æ‰€æœ‰Configuration
        modelBuilder.ApplyConfigurationsFromAssembly(typeof(RFSchedulingDbContext).Assembly);

        // Global Query Filter (Soft Delete)
        modelBuilder.Entity().HasQueryFilter(e => !e.IsDeleted);
        modelBuilder.Entity().HasQueryFilter(e => !e.IsDeleted);
        modelBuilder.Entity().HasQueryFilter(e => !e.IsDeleted);
        modelBuilder.Entity().HasQueryFilter(e => !e.IsDeleted);
        modelBuilder.Entity().HasQueryFilter(e => !e.IsDeleted);
        modelBuilder.Entity().HasQueryFilter(e => !e.IsDeleted);
    }

    public override async Task SaveChangesAsync(CancellationToken cancellationToken = default)
    {
        // è‡ªå‹•è¨­å®šCreatedDate/ModifiedDate
        var entries = ChangeTracker.Entries()
            .Where(e => e.State == EntityState.Added || e.State == EntityState.Modified);

        foreach (var entry in entries)
        {
            if (entry.State == EntityState.Added)
            {
                if (entry.Entity is ICreatable creatable)
                {
                    creatable.CreatedDate = DateTime.Now;
                }
            }

            if (entry.State == EntityState.Modified)
            {
                if (entry.Entity is IModifiable modifiable)
                {
                    modifiable.ModifiedDate = DateTime.Now;
                }
            }
        }

        return await base.SaveChangesAsync(cancellationToken);
    }
}
```

---

## 6. Serviceå±¤è¨­è¨ˆ

### 6.1 Serviceæ¶æ§‹

```
Services/
â”œâ”€â”€ Auth/
â”‚   â”œâ”€â”€ IAuthService.cs
â”‚   â”œâ”€â”€ AuthService.cs
â”‚   â””â”€â”€ PasswordService.cs
â”œâ”€â”€ Projects/
â”‚   â”œâ”€â”€ IProjectService.cs
â”‚   â””â”€â”€ ProjectService.cs
â”œâ”€â”€ WorkLogs/
â”‚   â”œâ”€â”€ IWorkLogService.cs
â”‚   â””â”€â”€ WorkLogService.cs
â”œâ”€â”€ Loading/
â”‚   â”œâ”€â”€ ILoadingService.cs
â”‚   â””â”€â”€ LoadingService.cs
â”œâ”€â”€ Email/
â”‚   â”œâ”€â”€ IEmailService.cs
â”‚   â””â”€â”€ EmailService.cs
â””â”€â”€ Common/
    â”œâ”€â”€ IAuditLogService.cs
    â””â”€â”€ AuditLogService.cs
```
---

## 7. éƒ¨ç½²æ¶æ§‹

### 7.1 éƒ¨ç½²æ‹“æ’²åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å…¬å¸å…§éƒ¨ç¶²è·¯                         â”‚
â”‚                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Client PC 1  â”‚  â”‚ Client PC 2  â”‚  ...       â”‚
â”‚  â”‚              â”‚  â”‚              â”‚            â”‚
â”‚  â”‚ WinForms App â”‚  â”‚ WinForms App â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                  â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                    â”‚ HTTPS                     â”‚
â”‚                    â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Application Server                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  IIS / Kestrel                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  ASP.NET Core Web API       â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  (.NET 8)                   â”‚  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ 
â”‚                    â”‚                           â”‚
â”‚                    â†“                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Database Server                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  SQL Server 2019 Express          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Database: RFScheduling           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ SMTP
                    â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  Email Server     â”‚
          â”‚  (å…¬å¸SMTP Server)â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

