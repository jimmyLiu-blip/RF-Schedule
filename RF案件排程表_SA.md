
# 📘 RF案件排程系統 — 系統分析文件 (SA v2.2)

---

## 📖 文件說明

**版本歷程：**
- v1.0 (2025-11-14)：初版分析文件
- v2.0 (2025-11-17)：調整職責邊界，移除技術實作細節
- v2.1 (2025-11-19)：補充混合登入機制（Local + Windows 驗證）、JWT 安全性說明、IAM 權限模型（Permission / PermissionGroup / UserPermission）
- v2.2 (2025-11-20)：補充 TestItem 狀態計算邏輯、狀態逆向操作規則、完整 ERD 圖

---

## 1. 專案背景與問題陳述

### 1.1 現況描述

RF測試實驗室目前面臨的挑戰：

**案件特性：**
- 單一案件需測試多種法規（FCC、NCC、CE、IC、TELEC等）
- 每個法規包含多種測試項目（Conducted、Radiated、Blocking等）
- 測試需在不同場地進行（Lab A、Lab B、Lab C等）
- 涉及多位工程師輪班作業（白班、小夜班、大夜班）

**當前管理方式：**
- 使用Excel試算表記錄案件資訊
- 透過Email與口頭溝通協調工作
- 工時記錄在個人筆記或Excel中
- 進度追蹤依賴人工整理

---

### 1.2 核心問題分析

#### 問題1：資訊分散與查詢困難
- **現象：** 案件資料散落在多個Excel檔案與Email中
- **影響：** 難以快速找到特定案件、法規或測項的進度

#### 問題2：工時追蹤不透明
- **現象：** 工程師各自記錄工時，無統一格式
- **影響：** 
  - 主管無法即時掌握實際工時
  - 補測版本(v1/v2/v3)工時混雜，無法比較分析
  - 預估與實際工時差異難以分析

#### 問題3：工程師負載無法視覺化
- **現象：** 主管無法即時看到每位工程師的負載狀況
- **影響：**
  - 任務分配不均，導致部分工程師超載
  - 無法提前預警資源瓶頸
  - 影響案件交期

#### 問題4：延遲原因難以追蹤
- **現象：** 僅知道案件「延遲」，但不清楚根本原因
- **影響：**
  - 無法針對性改善流程
  - 無法釐清責任歸屬（設備、客戶、人力、場地）
  - 重複發生相同問題

#### 問題5：缺乏權限控管與稽核
- **現象：** 
  - 任何人都可修改Excel，無記錄誰改了什麼
  - 資料被誤刪或覆蓋時無法追查
- **影響：** 資料可信度降低，發生爭議時無憑據

#### 問題6：多人協作版本衝突
- **現象：** 兩人同時編輯同一Excel，後存檔者覆蓋前者
- **影響：** 資料遺失，需重新輸入

---

## 1.3 使用者身份合併機制（Email-Based Identity Merge）

系統採用 **Email 作為跨登入來源的唯一身份識別（Primary Identity Key）**，用於整合 Local 帳密登入與 Windows AD 驗證登入，使同一位使用者以不同方式登入時，仍能被識別為同一個系統帳號。

### （1）合併原則
當使用者以任一方式登入（Local 或 AD）時，系統執行：

1. 從登入來源取得 Email（Local 由使用者輸入；AD 由 AD Server 提供）
2. 查詢：`SELECT * FROM Users WHERE Email = {LoginEmail}`
3. 若找到相同 Email → 視為同一使用者，不新增 User 紀錄
4. 若找不到 → 建立新使用者（依登入來源決定 AuthType）

### （2）Email 為唯一身份識別
- Email 欄位必須為 **唯一值（UNIQUE）**
- Local / AD 兩種登入方式都需提供 Email
- 不允許兩筆使用者用相同 Email

### （3）使用者分類

| 登入方式 | Email 來源 | 使用欄位 |
|----------|------------|----------|
| Local 帳密登入 | 使用者輸入 | Account + Email |
| AD 驗證登入 | AD 提供 | ADAccount + Email |

無論使用者以哪種方式登入，Email 相同即視為同一使用者。

---

## 2. 專案目標與成功指標

### 2.1 專案願景

> 建立一套集中化、可追蹤、可分析的RF案件排程與工時管理系統，讓工程師專注測試工作，讓主管即時掌握專案進度與資源負載。

---

### 2.2 專案目標

#### 目標1：集中化資料管理
- **描述：** 所有案件、法規、測項、工時資料集中儲存於單一系統
- **衡量指標：** 
  - 90%以上的資料查詢可在系統內完成
  - 不再需要Excel進行案件管理

#### 目標2：標準化流程
- **描述：** 透過Wizard流程標準化建案步驟

#### 目標3：即時工時追蹤
- **描述：** 工程師每日回報工時，系統即時累計與統計
- **衡量指標：** 
  - 工時回報即時性達100%（當日回報）

#### 目標4：視覺化資源負載
- **描述：** 主管可即時查看每位工程師的負載狀況

#### 目標5：延遲根因分析
- **描述：** 系統記錄延遲原因，支援統計分析
- **衡量指標：** 
  - 100%延遲案件有明確原因記錄
  - 每季產出延遲原因分析報告

#### 目標6：完整稽核機制
- **描述：** 所有資料異動皆可追蹤

---

## 3. 利害關係人分析

### 3.1 主要利害關係人

#### 3.1.1 工程師 (Engineer)
- **人數：** 約20人
- **需求：**
  - 快速查看自己負責的測項
  - 簡便的工時回報介面
  - 了解自己的工作進度
- **痛點：**
  - 現有Excel難以快速找到自己的任務
  - 工時記錄繁瑣易遺漏
  - 不清楚自己的Loading狀況
- **期望：**
  - 工時回報時間<2分鐘/次
  - 可隨時查看歷史工時記錄
  - 介面直覺易用

---

#### 3.1.2 實驗室主管 (Manager)
- **人數：** 3-5人
- **需求：**
  - 快速建立新案件
  - 即時掌握所有案件進度
  - 視覺化工程師負載
  - 分析延遲原因
  - 產出各類管理報表
- **痛點：**
  - Excel建案繁瑣易錯
  - 無法即時看到資源瓶頸
  - 手動彙整報表耗時
  - 延遲原因難以追蹤
- **期望：**
  - Wizard引導式建案
  - Dashboard一目了然
  - 一鍵產出報表
  - 完整稽核追蹤

---

## 4. 系統範圍定義

### 4.1 系統邊界

#### 4.1.1 納入範圍 (In Scope)

**核心功能：**
1. ✅ 案件管理（建立、查詢、修改、刪除）
2. ✅ 法規管理（多法規支援）
3. ✅ 測試項目管理（測項定義、工程師分配）
4. ✅ 工時回報（工程師端）
5. ✅ 工時查詢與統計（主管端）
6. ✅ Loading計算與視覺化
7. ✅ 延遲原因管理與分析
8. ✅ 補測版本管理（v1/v2/v3...）
9. ✅ 稽核日誌（資料異動追蹤）
10. ✅ 權限控管（工程師/主管）
11. ✅ 忘記密碼功能（Email重設）
12. ✅ 報表產出（進度、工時、延遲分析）

**資料管理：**
- ✅ 使用者管理
- ✅ 角色管理（Engineer/Manager）
- ✅ 延遲原因字典維護
- ✅ Soft Delete機制

---

### 4.2 系統與外部系統互動

```
┌─────────────────────────────────────┐
│   RF案件排程系統 (本系統)             │
│                                     │
│  ┌──────┐  ┌──────┐  ┌──────┐       │
│  │案件  │  │工時  │  │Loading│       │
│  │管理  │  │管理  │  │分析  │        │
│  └──────┘  └──────┘  └──────┘       │ 
│                                     │
└─────────────────────────────────────┘
         ↓ (Email)
┌─────────────────┐
│  Email Server   │ (發送密碼重設信、新帳號通知)
└─────────────────┘
```

**說明：**
- 系統僅與Email Server互動（發送系統通知信）
- 資料匯出格式：Excel（供人工匯入其他系統）

---

## 5. 功能需求總覽

### 5.1 功能模組架構

```
RF案件排程系統
│
├─ 1. 認證與授權模組
│   ├─ 1.1 使用者登入（Local 帳號）
│   ├─ 1.2 Windows 驗證登入（AD 帳號）
│   ├─ 1.3 忘記密碼（Email重設）
│   ├─ 1.4 角色與權限控管（RBAC + IAM）
│   │   ├─ 角色：Engineer / Manager / Admin
│   │   ├─ 權限：以 PermissionCode 控制
│   │   └─ 權限群組：預設權限集合，可個別加減
│   └─ 1.5 登入安全機制（失敗次數限制、Token 過期）
│
├─ 2. 案件管理模組
│   ├─ 2.1 Wizard建案流程
│   ├─ 2.2 案件查詢與瀏覽
│   ├─ 2.3 案件修改（含理由記錄）
│   ├─ 2.4 案件刪除（Soft Delete）
│   └─ 2.5 案件狀態自動計算
│
├─ 3. 測試項目管理模組
│   ├─ 3.1 測項新增與修改
│   ├─ 3.2 工程師分配（Main/Sub）
│   ├─ 3.3 補測版本管理（Revision）
│   ├─ 3.4 測項狀態追蹤與逆向操作
│   └─ 3.5 測項刪除（Soft Delete）
│
├─ 4. 工時管理模組
│   ├─ 4.1 工時回報（工程師端）
│   ├─ 4.2 工時查詢（工程師可查自己）
│   ├─ 4.3 工時修改（7天內可改）
│   ├─ 4.4 工時統計（主管端）
│   └─ 4.5 工時覆寫（主管含理由）
│
├─ 5. Loading分析模組
│   ├─ 5.1 工程師Loading總覽
│   ├─ 5.2 工程師Loading明細
│   └─ 5.3 Loading報表匯出
│
├─ 6. 延遲管理模組
│   ├─ 6.1 延遲原因字典維護
│   ├─ 6.2 延遲案件追蹤
│   └─ 6.3 延遲原因分析報表
│
├─ 7. 使用者管理模組
│   ├─ 7.1 使用者新增
│   ├─ 7.2 使用者修改
│   ├─ 7.3 使用者停用/啟用
│   └─ 7.4 使用者查詢
│
├─ 8. 稽核日誌模組
│   ├─ 8.1 自動記錄資料異動
│   ├─ 8.2 稽核日誌查詢
│   └─ 8.3 稽核日誌詳細檢視
│
├─ 9. 報表模組
│   ├─ 9.1 案件進度報表
│   ├─ 9.2 工時統計報表
│   ├─ 9.3 延遲分析報表
│   └─ 9.4 報表匯出（Excel）
│
└─ 10. 系統設定模組
    ├─ 10.1 一般參數設定
    ├─ 10.2 Email設定
    └─ 10.3 資料保留政策
```

---

### 5.2 使用案例圖 (Use Case Diagram)

```
┌─────────────────────────────────────────────┐
│           RF案件排程系統                      │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │  認證與授權                           │  │
│  │  • 登入（Local / AD）                 │  │
│  │  • 忘記密碼                           │  │
│  └──────────────────────────────────────┘  │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │  工程師功能                           │  │
│  │  • 查看我的測項                       │  │
│  │  • 回報工時                           │  │
│  │  • 查詢工時記錄                       │  │
│  │  • 修改工時(7天內)                    │  │
│  │  • 取消測項完成狀態                   │  │
│  └──────────────────────────────────────┘  │
│             ↑                               │
│         Engineer                            │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │  主管功能                             │  │
│  │  • Wizard建案                         │  │
│  │  • 管理案件                           │  │
│  │  • 管理測項與狀態覆寫                 │  │
│  │  • 分配工程師                         │  │
│  │  • 建立補測版本                       │  │
│  │  • 查看Loading報表                    │  │
│  │  • 查看延遲分析                       │  │
│  │  • 管理使用者與權限                   │  │
│  │  • 管理延遲原因                       │  │
│  │  • 查詢稽核日誌                       │  │
│  │  • 產出各類報表                       │  │
│  │  • 覆寫工時(含理由)                   │  │
│  └──────────────────────────────────────┘  │
│             ↑                               │
│          Manager                            │
│                                             │
└─────────────────────────────────────────────┘
```

---

## 6. 功能需求詳述

### 6.1 認證與授權需求

#### FR-AUTH-001：使用者登入（Local）
- **優先級：** 必須 (Must Have)
- **描述：** 使用者以帳號與密碼登入系統，登入成功後需依 Email 合併為最終身份識別
- **驗收標準：**
  - 驗證 Account 與 PasswordHash 是否正確
  - 取得使用者 Email，並以 Email 為唯一身份識別
  - 若 Email 已存在於其他登入來源（如 AD），則視為同一使用者
  - 停用帳號無法登入
  - 連續失敗 5 次需鎖定帳號 10 分鐘

#### FR-AUTH-101：Windows AD 登入（Email 合併版）
- **優先級：** 應該 (Should Have)
- **描述：** 支援 Windows AD 驗證登入，並以 Email 為唯一身份識別
- **驗收標準：**
  - 系統可取得 ADAccount、DisplayName、Email
  - 若 Email 存在於 User 表，視為同一使用者
  - 若 Email 不存在，建立新的 AD 使用者
  - AD 未提供 Email → 登入失敗
  - 停用帳號無法登入

#### FR-AUTH-102：JWT Token 驗證與 Payload 規範
- **優先級：** 必須 (Must Have)  
- **描述：** 系統使用 JWT 作為身份驗證憑證
- **驗收標準：**
  - JWT 結構：Header + Payload + Signature
  - Payload 只放授權相關必要資訊
  - 使用 HMAC-SHA256 簽章
  - 每次 API 呼叫需驗證 Token
  - Token 過期時間可由 SystemSetting 設定

#### FR-AUTH-002：密碼安全儲存
- **優先級：** 必須 (Must Have)
- **描述：** 密碼需以不可逆方式儲存
- **驗收標準：**
  - 資料庫儲存Hash值
  - 系統無任何功能可查看原密碼
  - Hash演算法使用業界標準（如bcrypt）

#### FR-AUTH-003：忘記密碼功能
- **優先級：** 必須 (Must Have)
- **描述：** 使用者可透過Email重設密碼
- **驗收標準：**
  - 可用帳號或Email申請重設
  - 系統發送重設連結至註冊Email
  - 連結30分鐘內有效
  - 連結僅能使用一次

#### FR-AUTH-004：角色權限控管
- **優先級：** 必須 (Must Have)
- **描述：** 系統需區分Engineer與Manager角色
- **驗收標準：**
  - Engineer僅能存取自己的功能
  - Manager可存取所有功能
  - 無權限時顯示明確錯誤訊息

---

### 6.2 案件管理需求

#### FR-PROJ-001：Wizard建案流程
- **優先級：** 必須 (Must Have)
- **描述：** 提供4步驟引導式建案流程
- **驗收標準：**
  - Step 1完成才能進Step 2
  - 可隨時返回前一步修改
  - Step 4完成顯示確認摘要
  - 確認後一次性寫入所有資料

#### FR-PROJ-002：案件基本資料管理
- **優先級：** 必須 (Must Have)
- **描述：** 可新增、查詢、修改、刪除案件
- **驗收標準：**
  - 案件名稱不可重複
  - 日期邏輯正確（結束≥開始）
  - 修改需填寫理由
  - 刪除採Soft Delete

#### FR-PROJ-003：案件狀態自動計算
- **優先級：** 必須 (Must Have)
- **描述：** 案件狀態依測項狀態自動更新
- **驗收標準：**
  - 任一測項延遲→案件延遲
  - 所有測項完成→案件完成
  - 有測項進行中→案件進行中
  - 主管可手動設為OnHold

---

### 6.3 測試項目管理需求

#### FR-TEST-001：測項新增與修改
- **優先級：** 必須 (Must Have)
- **描述：** 可在法規下新增測項
- **驗收標準：**
  - 預估工時需>0
  - 需指定測試類型與場地

#### FR-TEST-002：工程師分配
- **優先級：** 必須 (Must Have)
- **描述：** 可將測項分配給工程師
- **驗收標準：**
  - 至少需1位主要(Main)工程師
  - 可分配多位支援(Sub)工程師
  - 分配工時總和與預估工時差異>20%需警告
  - 顯示工程師當前Loading

#### FR-TEST-003：補測版本管理
- **優先級：** 必須 (Must Have)
- **描述：** 可建立測項的補測版本
- **驗收標準：**
  - 版本編號不可重複（v2/v3/v4...）
  - 可選擇複製原工程師分配
  - 建立補測後測項狀態改為InProgress
  - 需填寫補測原因

#### FR-TEST-004：測項狀態計算邏輯（新增）
- **優先級：** 必須 (Must Have)
- **描述：** TestItem 狀態依優先順序自動計算，並支援手動覆寫
- **驗收標準：**
  - **狀態計算優先順序：**
    1. IF 主管手動設定 OnHold → **OnHold**（最高優先級）
    2. ELSE IF 發生「建立 TestItemRevision」事件 → **InProgress**（補測事件覆蓋舊狀態）
    3. ELSE IF WorkLog 中存在 Delayed 狀態 → **Delayed**
    4. ELSE IF 任一工程師按「Complete TestItem」→ **Completed**
    5. ELSE IF WorkLog 中存在 InProgress 狀態 → **InProgress**
    6. ELSE → **NotStarted**（初始狀態）
  - 系統需記錄狀態變更歷程至 AuditLog
  - 主管手動設定的 OnHold 狀態需額外標記，避免被自動邏輯覆蓋

#### FR-TEST-005：測項狀態逆向操作（新增）
- **優先級：** 必須 (Must Have)
- **描述：** TestItem 狀態允許逆向修改，非單向不可逆
- **驗收標準：**
  - **工程師權限：**
    - 可取消自己誤按的 Completed 狀態
    - 可將 Completed 改回 InProgress
    - 需提供「取消完成」按鈕
    - 取消操作需寫入 AuditLog
  - **主管權限：**
    - 可覆寫 TestItem 的任何狀態
    - 可修改：Completed → InProgress / Delayed / OnHold
    - 可修改：Delayed → InProgress / Completed
    - 可修改：OnHold → 任何狀態
    - 修改需填寫理由，記錄至 AuditLog
  - **自動狀態亦可覆寫：**
    - 建立 TestItemRevision 自動產生的 InProgress 可由主管手動改為其他狀態
  - 所有狀態變更皆需記錄：Who / When / From / To / Why

---

### 6.4 工時管理需求

#### FR-WORK-001：工時回報
- **優先級：** 必須 (Must Have)
- **描述：** 工程師可回報每日工時
- **驗收標準：**
  - 工作日期不可晚於今天
  - 單日工時0.5-12小時
  - 同測項同日期不可重複回報
  - 狀態=延遲時必須選延遲原因

#### FR-WORK-002：工時修改限制
- **優先級：** 必須 (Must Have)
- **描述：** 工程師可修改7天內的工時
- **驗收標準：**
  - 7天內可修改
  - 超過7天顯示錯誤訊息
  - 修改後寫入AuditLog

#### FR-WORK-003：工時狀態同步
- **優先級：** 必須 (Must Have)
- **描述：** 工時回報後自動更新測項狀態
- **驗收標準：**
  - 首次回報→測項InProgress
  - 任一工程師回報延遲→測項Delayed
  - 工程師按完成→觸發測項狀態重算

#### FR-WORK-004：工時查詢
- **優先級：** 必須 (Must Have)
- **描述：** 工程師可查詢自己的工時記錄
- **驗收標準：**
  - 可依測項篩選
  - 可依日期區間篩選
  - 可依版本篩選
  - 顯示統計資訊（總工時、剩餘工時）

#### FR-WORK-005：主管覆寫工時
- **優先級：** 應該 (Should Have)
- **描述：** 主管可修改任何工時記錄
- **驗收標準：**
  - 需填寫修改理由
  - 理由寫入AuditLog
  - 原值與新值皆記錄

---

### 6.5 Loading分析需求

#### FR-LOAD-001：Loading計算
- **優先級：** 必須 (Must Have)
- **描述：** 系統自動計算工程師Loading
- **驗收標準：**
  - Assigned Loading = Σ(分配工時) / 可用工時 × 100%
  - Actual Loading = Σ(實際工時) / 可用工時 × 100%
  - 僅計算Active狀態案件

#### FR-LOAD-002：Loading視覺化
- **優先級：** 必須 (Must Have)
- **描述：** 以顏色標示Loading狀態
- **驗收標準：**
  - ≤60%：綠色
  - 61-80%：黃色
  - 81-100%：橘色
  - >100%：紅色（超載）

#### FR-LOAD-003：Loading明細
- **優先級：** 必須 (Must Have)
- **